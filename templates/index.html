<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Night Werewolf</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #2c3e50;
            color: white;
        }
        .container {
            background-color: #34495e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background-color: #e74c3c;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #c0392b;
        }
        .hidden {
            display: none;
        }
        #messages {
            height: 200px;
            overflow-y: auto;
            background-color: #2c3e50;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .role-info {
            background-color: #1a252f;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #e74c3c;
        }
        .phase-info {
            background-color: #1a252f;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f39c12;
        }
        .action-buttons {
            margin-top: 15px;
        }
        .action-buttons button {
            margin: 5px;
            background-color: #3498db;
        }
        .action-buttons button:hover {
            background-color: #2980b9;
        }
        .center-card-btn {
            background-color: #9b59b6 !important;
        }
        .center-card-btn:hover {
            background-color: #8e44ad !important;
        }
        .game-log {
            background-color: #2c3e50;
            padding: 10px;
            border-radius: 5px;
            height: 150px;
            overflow-y: auto;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>üê∫ One Night Werewolf</h1>
    
    <!-- Pantalla de unirse -->
    <div id="join-screen" class="container">
        <h3>üéÆ Unirse al juego</h3>
        <input type="text" id="username" placeholder="Tu nombre" maxlength="20">
        <br><br>
        
        <button onclick="createRoom()" style="background-color: #27ae60;">üÜï Crear Sala Nueva</button>
        <br><br>
        
        <div style="margin: 10px 0; text-align: center;">--- O ---</div>
        
        <input type="text" id="room-code" placeholder="C√≥digo de sala (ej: SALA1)" maxlength="10">
        <button onclick="joinRoom()">üîó Unirse a Sala</button>
        
        <div id="connection-status">Estado: Desconectado</div>
    </div>

    <!-- Pantalla de sala -->
    <div id="lobby-screen" class="container hidden">
        <h3>üìã Sala: <span id="current-room">----</span></h3>
        <p><strong>Tu nombre:</strong> <span id="your-username">----</span></p>
        
        <div class="container">
            <h4>üë• Jugadores en la sala:</h4>
            <div id="player-list">Esperando jugadores...</div>
        </div>
        
        <button onclick="startGame()">üöÄ Iniciar Juego</button>
        <button onclick="leaveRoom()">üö™ Salir</button>
    </div>

    <!-- Pantalla de juego -->
    <div id="game-screen" class="container hidden">
        <h3 id="game-title">üåô Noche - Preparando...</h3>
        
        <!-- Informaci√≥n del rol -->
        <div id="role-info" class="role-info">
            <h4>Tu Rol:</h4>
            <p><strong id="your-role">Esperando asignaci√≥n...</strong></p>
            <p id="role-description">El juego est√° comenzando...</p>
        </div>
        
        <!-- Informaci√≥n de la fase actual -->
        <div id="phase-info" class="phase-info">
            <h4>Fase Actual:</h4>
            <p id="phase-description">Preparando...</p>
            
            <!-- Botones de acci√≥n -->
            <div id="action-buttons" class="action-buttons hidden">
                <!-- Los botones aparecer√°n aqu√≠ din√°micamente -->
            </div>
        </div>
        
        <!-- Log del juego -->
        <div class="container">
            <h4>üìú Log del juego:</h4>
            <div id="game-log" class="game-log">
                <p>El juego est√° comenzando...</p>
            </div>
        </div>
    </div>

    <!-- Debug/Mensajes -->
    <div class="container">
        <h4>üîß Debug:</h4>
        <div id="messages"></div>
    </div>

    <script>
        const socket = io();

        // Variables globales
        let currentUsername = '';
        let currentRoom = '';
        let currentRole = '';
        let gamePhase = '';

        // Referencias DOM
        const joinScreen = document.getElementById('join-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');

        // Debug: Escuchar todos los eventos
        socket.onAny((eventName, ...args) => {
            console.log(`üîß EVENT: ${eventName}`, args);
            addMessage(`EVENT: ${eventName} - ${JSON.stringify(args).substring(0, 100)}...`);
        });

        // === EVENTOS DEL SOCKET ===

        socket.on('connect', function() {
            updateConnectionStatus('Conectado ‚úÖ');
            addMessage('Conectado al servidor');
        });

        socket.on('disconnect', function() {
            updateConnectionStatus('Desconectado ‚ùå');
            addMessage('Desconectado del servidor');
            showJoinScreen();
        });

        socket.on('room_created', function(data) {
            addMessage(`‚úÖ Sala creada: ${data.room} - C√≥digo: ${data.room}`);
            currentUsername = data.username;
            currentRoom = data.room;
            showLobbyScreen();
        });

        socket.on('room_joined', function(data) {
            addMessage(`‚úÖ Te uniste a la sala: ${data.room}`);
            currentUsername = data.username;
            currentRoom = data.room;
            showLobbyScreen();
        });

        socket.on('room_updated', function(data) {
            updatePlayerList(data.players);
        });

        socket.on('game_started', function(data) {
            addMessage('üéÆ ¬°Juego iniciado!');
            showGameScreen();
            addGameLog('üåô El juego ha comenzado. Es de noche...');
        });

        socket.on('your_role', function(data) {
            currentRole = data.role;
            document.getElementById('your-role').textContent = data.role_name;
            document.getElementById('role-description').textContent = `Eres: ${data.role_name}`;
            addGameLog(`üé≠ Tu rol es: ${data.role_name}`);
        });

        socket.on('night_phase_started', function(data) {
            gamePhase = data.phase;
            document.getElementById('game-title').textContent = `üåô Noche - Fase: ${data.role_name}`;
            document.getElementById('phase-description').textContent = data.description;
            addGameLog(`--- Fase: ${data.role_name} ---`);

            // L√≥gica espec√≠fica para lobos
            if (data.phase === 'werewolf') {
                handleWerewolfPhase(data);
            } else {
                // Para otras fases futuras
                if (data.players_can_act && data.players_can_act.some(p => p.socket_id === socket.id)) {
                    showActionButtons(['Actuar']);
                }
            }
        });

        socket.on('action_result', function(data) {
            if (data.success) {
                if (data.center_card) {
                    addGameLog(`üÉè Carta del centro ${data.center_card.index + 1}: ${data.center_card.role}`);
                }
                hideActionButtons();
            } else {
                addGameLog(`‚ùå Error: ${data.error}`);
            }
        });

        // === FUNCIONES DE MANEJO DE FASES ===

        function handleWerewolfPhase(data) {
            if (currentRole === 'werewolf') {
                if (data.is_lone_wolf) {
                    addGameLog('üëÅÔ∏è Eres el √∫nico lobo. Puedes ver una carta del centro.');
                    showCenterCardButtons();
                } else if (data.other_werewolves) {
                    const otherWolves = data.other_werewolves.map(w => w.username).join(', ');
                    addGameLog(`üëÅÔ∏è Otros lobos: ${otherWolves}`);
                    addGameLog('Como hay m√∫ltiples lobos, no puedes ver cartas del centro.');
                }
            }
        }

        // === FUNCIONES DE INTERFAZ ===

        function showJoinScreen() {
            joinScreen.classList.remove('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
        }

        function showLobbyScreen() {
            joinScreen.classList.add('hidden');
            lobbyScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');

            document.getElementById('current-room').textContent = currentRoom;
            document.getElementById('your-username').textContent = currentUsername;
        }

        function showGameScreen() {
            joinScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
        }

        function showActionButtons(buttons) {
            const actionDiv = document.getElementById('action-buttons');
            actionDiv.innerHTML = '';
            actionDiv.classList.remove('hidden');

            buttons.forEach(buttonText => {
                const button = document.createElement('button');
                button.textContent = buttonText;
                button.onclick = () => performAction(buttonText);
                actionDiv.appendChild(button);
            });
        }

        function showCenterCardButtons() {
            const actionDiv = document.getElementById('action-buttons');
            actionDiv.innerHTML = '';
            actionDiv.classList.remove('hidden');

            for (let i = 0; i < 3; i++) {
                const button = document.createElement('button');
                button.textContent = `üÉè Ver carta centro ${i + 1}`;
                button.className = 'center-card-btn';
                button.onclick = () => chooseCenterCard(i);
                actionDiv.appendChild(button);
            }
        }

        function hideActionButtons() {
            document.getElementById('action-buttons').classList.add('hidden');
        }

        function updatePlayerList(players) {
            const listDiv = document.getElementById('player-list');
            if (players.length === 0) {
                listDiv.textContent = 'No hay jugadores';
                return;
            }

            listDiv.innerHTML = '';
            players.forEach(playerName => {
                const playerDiv = document.createElement('div');
                playerDiv.textContent = `üë§ ${playerName}`;
                listDiv.appendChild(playerDiv);
            });
        }

        function updateConnectionStatus(status) {
            document.getElementById('connection-status').textContent = `Estado: ${status}`;
        }

        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addGameLog(message) {
            const logDiv = document.getElementById('game-log');
            const logElement = document.createElement('p');
            logElement.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.appendChild(logElement);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // === FUNCIONES DE ACCIONES ===

        function createRoom() {
            const username = document.getElementById('username').value.trim();

            if (!username) {
                alert('Por favor ingresa tu nombre');
                return;
            }

            // Generar c√≥digo de sala aleatorio
            const roomCode = generateRoomCode();
            
            addMessage(`Creando sala ${roomCode} como ${username}`);
            socket.emit('join', {
                username: username,
                room: roomCode
            });
        }

        function joinRoom() {
            const username = document.getElementById('username').value.trim();
            const room = document.getElementById('room-code').value.trim();

            if (!username || !room) {
                alert('Por favor ingresa tu nombre y c√≥digo de sala');
                return;
            }

            addMessage(`Intentando unirse a sala ${room} como ${username}`);
            socket.emit('join', {
                username: username,
                room: room
            });
        }

        function generateRoomCode() {
            // Generar c√≥digo de 4 letras aleatorio
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            return code;
        }

        function startGame() {
            if (!currentRoom) {
                alert('No est√°s en una sala');
                return;
            }

            addMessage('Iniciando juego...');
            socket.emit('start_game', {
                room: currentRoom
            });
        }

        function leaveRoom() {
            location.reload(); // M√©todo simple para salir
        }

        function performAction(action) {
            addGameLog(`Realizando acci√≥n: ${action}`);
            socket.emit('role_action', {
                room: currentRoom,
                phase: gamePhase,
                action_data: { action: action }
            });
        }

        function chooseCenterCard(index) {
            addGameLog(`Eligiendo carta del centro ${index + 1}...`);
            socket.emit('role_action', {
                room: currentRoom,
                phase: 'werewolf',
                action_data: { center_index: index }
            });
        }

        // === EVENT LISTENERS ===

        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                createRoom(); // Por defecto, crear sala nueva con Enter
            }
        });

        document.getElementById('room-code').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinRoom();
            }
        });

        // Convertir c√≥digo de sala a may√∫sculas autom√°ticamente
        document.getElementById('room-code').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    </script>
</body>
</html>